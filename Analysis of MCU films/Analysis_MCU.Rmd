---
title: "Analyzing Marvel Cinematic Universe films from 2008 - 2019"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
In this project, I scraped, cleaned, and transformed HTML tables of Marvel Cinematic Universe films from https://en.wikipedia.org/wiki/List_of_Marvel_Cinematic_Universe_films. Afterwards, I analyzed the data and visualized my findings with ggplot2.

Loading packages
```{r}
library(rvest)
library(dplyr)
library(ggplot2)
library(tidyr)
library(ggrepel)
library(gridExtra)
```


Extracting and cleaning the Critical Response and Box Office Performance tables and merging them into a single data frame.
```{r}
movie_table <- read_html("https://en.wikipedia.org/wiki/List_of_Marvel_Cinematic_Universe_films")
boxoff <- html_table(html_nodes(movie_table, "table")[[10]],fill=T)[c(-1,-24),c(-3,-4,-6,-7,-9)] 
critical <- html_table(html_nodes(movie_table, "table")[[11]],fill=T)[-23,]
merged <- merge(boxoff,critical,by.x="Film",by.y="Film")
colnames(merged)[3] <- "Box.Office.Gross.Worldwide"
colnames(merged)[2] <- "Year"
colnames(merged) <- make.names(colnames(merged))
merged
```

Now I will start by keeping the columns: Box office gross worldwide, release year, Budget, Rotten Tomatoes scores, and Metacritic scores. Also, I will create a new 'Revenue' column.

Removing the days and months while keeping the year and converting to numeric values
```{r}
a=regexpr("[[:digit:]]{4}", merged$Year)
merged$Year <- regmatches(merged$Year,a) %>% as.numeric() 
```

Removing the "$" and "," from the gross column and converting to numeric values
```{r}
merged$Box.Office.Gross.Worldwide <- gsub("(\\$|,)", "", merged$Box.Office.Gross.Worldwide) %>% as.numeric()
```

Removed symbols and converted the net budget to numeric values by multiplying by 1000000
```{r}
c=gsub("(\\$|\\s{1}million)", "", merged$Budget) 
merged$Budget <- gsub("[[:digit:]]{3}(\\â€“){1}","",c) %>% as.numeric()*1000000
```

Removed symbols and only kept the scores as numeric values
```{r}
merged$Rotten.Tomatoes <- substr(merged$Rotten.Tomatoes,1,2) %>% as.numeric()
```

Removed symbols and only kept the scores as numeric values
```{r}
merged$`Metacritic` <- substr(merged$`Metacritic`,1,2) %>% as.numeric()
```

Adding new 'Revenue' feature to the merged data frame
```{r}
merged <- mutate(merged, Revenue=Box.Office.Gross.Worldwide-Budget)
```

Cleaned and merged table
```{r}
write.csv(merged, "CleanedMarvel.csv")
merged
```

Plotting Box Office Gross Worldwide and Budget over time with a smooth loess curve. The budget seems to be fairly constant throughout the years however gross has fallen slightly in 2015 - 2017 and begins increasing again in 2017 more at a higher rate than previous years
```{r}
ggplot(data=merged, aes(x=Year)) + 
  geom_point(aes(y=Box.Office.Gross.Worldwide, colour="Gross")) +
  geom_smooth(aes(y=Box.Office.Gross.Worldwide, colour="Gross"), method="loess") +
  geom_point(data=merged,aes(y=Budget,colour="Budget")) +
  geom_smooth(data=merged,aes(y=Budget,colour="Budget"), method="loess", se=F) +
  scale_x_continuous(breaks=c(2008:2019)) +
  labs(title="Box Dffice Gross worldwide and Budget income over time for MCU movies") +
  ylab(label="Dollars") +
  scale_colour_manual(name="", values=c(Gross="black", Budget="red"))
```

Plotting the distribution of gross revennue for MCU movies. The red dashed line represents the mean revenue and the black surve represents the density curve. The distribution appears to be positively skewed to the right which means the mean (~$765 million) is greater than the median (~$620 million).
```{r}
ggplot(data=merged, aes(x=Revenue)) + 
  geom_histogram(aes(y=..density..),bins=25, colour="dodgerblue4", fill="skyblue") +
  geom_density(color="black") +
  geom_vline(xintercept = mean(merged$Revenue), color = "red", linetype = "dashed") +
  labs(title="Distribution of Revenue for MCU movies") +
  xlab(label="Revenue (Dollars)") +
  ylab(label="Density")
```

Plotting the relationship of Budget vs Gross Revenue for MCU movies. The graphs seems to suggest that they have a positive relationship
```{r}
ggplot(merged, aes(x=Revenue, y=Budget)) +
  geom_point() +
  geom_smooth(method="loess",colour="#00BA38") +
  ylab(label="Budget (Dollars)") +
  xlab(label="Revenue (Dollars)") +
  labs(title="Budget vs Revenue for MCU movies")
```

Plotting Metacritic scores vs Rotten Tomatoes scores.They seem to have a positive relatiionship, however it is not proportional. Metacritic appears to give lower ratings than Rotten Tomatoes
```{r}
ggplot(merged, aes(x=Metacritic, Rotten.Tomatoes)) +
  geom_point(size=.5) +
  geom_text_repel(label=merged$Film, size=3,size=3) +
  xlim(50,100) +
  ylim(50,100) +
  geom_line(colour="#F8766D", alpha=.6, method="loess", stat="smooth", size=1.3) +
  labs(title="Metacritic ratings vs Rotten Tomatoes ratings of MCU Movies") +
  ylab(label="Rotten Tomatoes scores") +
  xlab(label="Metacritic scores")

```

Split-apply-combine analysis to find the year with the higest revenue and plotting Revenue vs Year. The graphs shows that 2018 2019 MCU movies brought in the highest Revenue income.
```{r}
merged %>%
  group_by(Year) %>%
  summarize(Total.Revenue=sum(Revenue)) %>%
  ggplot(aes(x=Year, y=Total.Revenue)) + 
  geom_bar(stat="identity", fill="#F8766D", position="dodge") +
  geom_text(aes(label=Total.Revenue), position=position_dodge(width=0.1), size=2.3, vjust=-.25,) +
  scale_x_continuous(breaks=c(2008:2019)) +
  labs(title="Total Revenue vs Year of MCU movies") +
  ylab(label="Total Revenue")
```

Plotting Metacritic and Rotten Tomatoes rating scores over time. In general, Rotten Tomatoes reviewers appears to give more generous ratings than Metacritic reviewers. The graphs suggests that the ratings are increasing the but have fallen a bit since 2018.
```{r}
plot1 <- ggplot(merged, aes(x=Year, y=Metacritic)) + 
  geom_point() +
  geom_smooth(method="loess") +
  scale_x_continuous(breaks=c(2008:2019)) +
  ylim(50,100) +
  labs(title="Metacritic rating scores \n over time of MCU movies") +
  ylab(label="Metacritic Scores")

plot2 <- ggplot(merged, aes(x=Year, y=Rotten.Tomatoes)) + 
  geom_point() +
  geom_smooth(method="loess") +
  scale_x_continuous(breaks=c(2008:2019)) +
  ylim(50,100) +
  labs(title="Rotten Tomateos rating scores \n over time of MCU movies") +
  ylab(label="Rotten Tomatoes scores")

grid.arrange(plot1, plot2, ncol=2)
```

